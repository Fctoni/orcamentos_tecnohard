# üîÆ Fases Futuras

**Funcionalidades planejadas para implementa√ß√£o futura**

---

## üìä Exporta√ß√£o CSV/Excel

### Objetivo
Permitir exportar or√ßamentos individuais ou em lote para CSV e Excel.

### Depend√™ncia
```bash
npm install xlsx
```

### API de Exporta√ß√£o

**`app/api/export/route.ts`:**

```typescript
import { NextRequest, NextResponse } from 'next/server'
import * as XLSX from 'xlsx'
import { createClient } from '@/lib/supabase/server'
import { format } from 'date-fns'
import { ptBR } from 'date-fns/locale'

export async function GET(request: NextRequest) {
  try {
    const searchParams = request.nextUrl.searchParams
    const id = searchParams.get('id')
    const formatType = searchParams.get('format') || 'csv'

    if (!id) {
      return NextResponse.json({ error: 'ID n√£o fornecido' }, { status: 400 })
    }

    const supabase = await createClient()

    // Buscar or√ßamento com itens
    const { data: orcamento, error } = await supabase
      .from('orcamentos')
      .select(`
        *,
        itens:orcamento_itens(*)
      `)
      .eq('id', id)
      .single()

    if (error || !orcamento) {
      return NextResponse.json({ error: 'Or√ßamento n√£o encontrado' }, { status: 404 })
    }

    // Ordenar itens
    if (orcamento.itens) {
      orcamento.itens.sort((a: any, b: any) => a.ordem - b.ordem)
    }

    const formatCurrency = (value: number) => {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
      }).format(value)
    }

    if (formatType === 'csv') {
      // Gerar CSV
      const csvData = generateCSV(orcamento, formatCurrency)
      
      return new NextResponse(csvData, {
        headers: {
          'Content-Type': 'text/csv; charset=utf-8',
          'Content-Disposition': `attachment; filename="Orcamento-${orcamento.numero}.csv"`,
        },
      })
    } else if (formatType === 'xlsx') {
      // Gerar Excel
      const excelBuffer = generateExcel(orcamento, formatCurrency)
      
      return new NextResponse(excelBuffer, {
        headers: {
          'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
          'Content-Disposition': `attachment; filename="Orcamento-${orcamento.numero}.xlsx"`,
        },
      })
    }

    return NextResponse.json({ error: 'Formato inv√°lido' }, { status: 400 })
  } catch (error) {
    console.error('Erro na exporta√ß√£o:', error)
    return NextResponse.json({ error: 'Erro na exporta√ß√£o' }, { status: 500 })
  }
}

function generateCSV(orcamento: any, formatCurrency: (v: number) => string): string {
  // BOM para UTF-8
  const BOM = '\uFEFF'
  
  const lines: string[] = []
  
  // Cabe√ßalho do or√ßamento
  lines.push('OR√áAMENTO')
  lines.push(`N√∫mero;${orcamento.numero}`)
  lines.push(`Cliente;${orcamento.cliente}`)
  if (orcamento.contato) lines.push(`Contato;${orcamento.contato}`)
  if (orcamento.validade) {
    lines.push(`Validade;${format(new Date(orcamento.validade), 'dd/MM/yyyy', { locale: ptBR })}`)
  }
  if (orcamento.frete) lines.push(`Frete;${orcamento.frete}`)
  lines.push('')
  
  // Itens
  lines.push('ITENS')
  lines.push('C√≥digo;Item;Unidade;Quantidade;Peso Unit.;Pre√ßo Unit.;Total;Material;Processos;Prazo;Fat. M√≠nimo')
  
  if (orcamento.itens) {
    for (const item of orcamento.itens) {
      const row = [
        item.codigo_item,
        item.item,
        item.unidade,
        item.quantidade,
        item.peso_unitario || '',
        formatCurrency(item.preco_unitario),
        formatCurrency(item.preco_total),
        item.material || '',
        item.processos?.join(', ') || '',
        item.prazo_entrega || '',
        item.faturamento_minimo || '',
      ]
      lines.push(row.map(v => `"${v}"`).join(';'))
    }
  }
  
  lines.push('')
  if (!orcamento.ocultar_valor_total) {
    lines.push(`VALOR TOTAL;${formatCurrency(orcamento.valor_total)}`)
  }
  
  if (orcamento.observacoes) {
    lines.push('')
    lines.push('OBSERVA√á√ïES')
    lines.push(orcamento.observacoes)
  }
  
  return BOM + lines.join('\n')
}

function generateExcel(orcamento: any, formatCurrency: (v: number) => string): Buffer {
  const workbook = XLSX.utils.book_new()
  
  // Aba 1: Dados do Or√ßamento
  const dadosOrcamento = [
    ['OR√áAMENTO', ''],
    ['N√∫mero', orcamento.numero],
    ['Cliente', orcamento.cliente],
    ['Contato', orcamento.contato || ''],
    ['Validade', orcamento.validade ? format(new Date(orcamento.validade), 'dd/MM/yyyy', { locale: ptBR }) : ''],
    ['Frete', orcamento.frete || ''],
    ['Status', orcamento.status],
    ['Valor Total', !orcamento.ocultar_valor_total ? formatCurrency(orcamento.valor_total) : '(oculto)'],
    ['', ''],
    ['Observa√ß√µes', orcamento.observacoes || ''],
  ]
  
  const wsDados = XLSX.utils.aoa_to_sheet(dadosOrcamento)
  wsDados['!cols'] = [{ wch: 15 }, { wch: 50 }]
  XLSX.utils.book_append_sheet(workbook, wsDados, 'Dados')
  
  // Aba 2: Itens
  const itensHeader = [
    'C√≥digo', 'Item', 'Un', 'Qtd', 'Peso Unit.', 
    'Pre√ßo Unit.', 'Total', 'Material', 'Processos', 'Prazo', 'Fat. M√≠nimo'
  ]
  
  const itensData = [itensHeader]
  
  if (orcamento.itens) {
    for (const item of orcamento.itens) {
      itensData.push([
        item.codigo_item,
        item.item,
        item.unidade,
        item.quantidade,
        item.peso_unitario || '',
        item.preco_unitario,
        item.preco_total,
        item.material || '',
        item.processos?.join(', ') || '',
        item.prazo_entrega || '',
        item.faturamento_minimo || '',
      ])
    }
  }
  
  const wsItens = XLSX.utils.aoa_to_sheet(itensData)
  wsItens['!cols'] = [
    { wch: 12 }, { wch: 40 }, { wch: 6 }, { wch: 8 }, { wch: 10 },
    { wch: 12 }, { wch: 12 }, { wch: 20 }, { wch: 30 }, { wch: 15 }, { wch: 15 }
  ]
  XLSX.utils.book_append_sheet(workbook, wsItens, 'Itens')
  
  return Buffer.from(XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' }))
}
```

### Bot√µes na Interface

Adicionar ao `orcamento-view.tsx`:

```typescript
<DropdownMenu>
  <DropdownMenuTrigger asChild>
    <Button variant="outline">
      <FileSpreadsheet className="mr-2 h-4 w-4" /> Exportar
    </Button>
  </DropdownMenuTrigger>
  <DropdownMenuContent>
    <DropdownMenuItem onClick={handleExportCSV}>
      üìä Exportar CSV
    </DropdownMenuItem>
    <DropdownMenuItem onClick={handleExportExcel}>
      üìä Exportar Excel
    </DropdownMenuItem>
  </DropdownMenuContent>
</DropdownMenu>
```

### Exporta√ß√£o em Lote

Adicionar funcionalidade de exportar m√∫ltiplos or√ßamentos selecionados na lista.

---

## üîç Busca Avan√ßada de Itens

### Objetivo
Permitir buscar or√ßamentos pelo conte√∫do dos itens (c√≥digo, descri√ß√£o, material).

### Implementa√ß√£o
Criar uma busca full-text no Supabase ou implementar busca client-side nos itens carregados.

---

## üìà Dashboard e Relat√≥rios

### Objetivo
Criar um dashboard com m√©tricas e relat√≥rios visuais.

### M√©tricas sugeridas
- Total de or√ßamentos por status
- Valor total por per√≠odo
- Clientes mais frequentes
- Itens mais or√ßados

---

## üîî Notifica√ß√µes

### Objetivo
Notificar sobre or√ßamentos pr√≥ximos do vencimento.

### Implementa√ß√£o
- Email autom√°tico X dias antes da validade
- Notifica√ß√£o no sistema

---

## üì± PWA / App Mobile

### Objetivo
Transformar o sistema em um PWA para acesso mobile.

### Funcionalidades
- Offline support
- Push notifications
- Instala√ß√£o na home screen

---

## üîó Integra√ß√µes

### Objetivo
Integrar com outros sistemas.

### Poss√≠veis integra√ß√µes
- ERP da empresa
- WhatsApp para envio de or√ßamentos
- Assinatura digital

---

## üé® Temas e Personaliza√ß√£o

### Objetivo
Permitir personaliza√ß√£o visual.

### Funcionalidades
- Tema claro/escuro
- Cores customiz√°veis
- Logo personalizado por usu√°rio

